"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8398],{1821:(n,e,r)=>{r.d(e,{A:()=>o});const o=r.p+"assets/images/20250414-xorm-update-process_design-dd11b9b8a41d61e0f917ffa469b03603.png"},2251:n=>{n.exports=JSON.parse('{"permalink":"/blog/xorm-update-process","editUrl":"https://github.com/gone-io/v2-site/tree/main/blog/blog/2025-04-14-xorm-update-process.md","source":"@site/blog/2025-04-14-xorm-update-process.md","title":"\u4f7f\u7528Provider\u673a\u5236\u6539\u9020goner/xorm","description":"\u672c\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4f7f\u7528Gone\u6846\u67b6\u7684Provider\u673a\u5236\u91cd\u6784goner/xorm\u7ec4\u4ef6\u7684\u8fc7\u7a0b\u3002\u901a\u8fc7\u7edf\u4e00\u4f7f\u7528Provider\u673a\u5236\u5b9e\u73b0\uff0c\u4f18\u5316\u4e86\u4ee3\u7801\u7ed3\u6784\uff0c\u63d0\u9ad8\u4e86\u53ef\u7ef4\u62a4\u6027\u548c\u6d4b\u8bd5\u8986\u76d6\u7387\uff0c\u540c\u65f6\u4fdd\u6301\u4e86\u539f\u6709\u529f\u80fd\u548c\u914d\u7f6e\u7684\u517c\u5bb9\u6027\u3002\u6587\u7ae0\u6db5\u76d6\u4e86\u91cd\u6784\u7684\u52a8\u673a\u3001\u76ee\u6807\u3001\u8bbe\u8ba1\u65b9\u6848\u3001\u5b9e\u73b0\u7ec6\u8282\u548c\u6d4b\u8bd5\u7b56\u7565\u3002","date":"2025-04-14T00:00:00.000Z","tags":[{"inline":true,"label":"xorm","permalink":"/blog/tags/xorm"},{"inline":true,"label":"gone","permalink":"/blog/tags/gone"},{"inline":true,"label":"\u6570\u636e\u5e93\u8bbf\u95ee","permalink":"/blog/tags/\u6570\u636e\u5e93\u8bbf\u95ee"},{"inline":true,"label":"\u4ee3\u7801\u91cd\u6784","permalink":"/blog/tags/\u4ee3\u7801\u91cd\u6784"},{"inline":true,"label":"\u6d4b\u8bd5\u8986\u76d6\u7387","permalink":"/blog/tags/\u6d4b\u8bd5\u8986\u76d6\u7387"},{"inline":true,"label":"\u4e8b\u52a1\u7ba1\u7406","permalink":"/blog/tags/\u4e8b\u52a1\u7ba1\u7406"}],"readingTime":19.38,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"xorm-update-process","description":"\u672c\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4f7f\u7528Gone\u6846\u67b6\u7684Provider\u673a\u5236\u91cd\u6784goner/xorm\u7ec4\u4ef6\u7684\u8fc7\u7a0b\u3002\u901a\u8fc7\u7edf\u4e00\u4f7f\u7528Provider\u673a\u5236\u5b9e\u73b0\uff0c\u4f18\u5316\u4e86\u4ee3\u7801\u7ed3\u6784\uff0c\u63d0\u9ad8\u4e86\u53ef\u7ef4\u62a4\u6027\u548c\u6d4b\u8bd5\u8986\u76d6\u7387\uff0c\u540c\u65f6\u4fdd\u6301\u4e86\u539f\u6709\u529f\u80fd\u548c\u914d\u7f6e\u7684\u517c\u5bb9\u6027\u3002\u6587\u7ae0\u6db5\u76d6\u4e86\u91cd\u6784\u7684\u52a8\u673a\u3001\u76ee\u6807\u3001\u8bbe\u8ba1\u65b9\u6848\u3001\u5b9e\u73b0\u7ec6\u8282\u548c\u6d4b\u8bd5\u7b56\u7565\u3002","keywords":["\u4f9d\u8d56\u6ce8\u5165","\u6570\u636e\u5e93\u8bbf\u95ee","\u4ee3\u7801\u91cd\u6784","Provider\u6a21\u5f0f","xorm","Gone\u6846\u67b6","\u6d4b\u8bd5\u8986\u76d6\u7387","\u4e8b\u52a1\u7ba1\u7406","SQL\u62fc\u63a5","\u4ee3\u7801\u4f18\u5316"],"tags":["xorm","gone","\u6570\u636e\u5e93\u8bbf\u95ee","\u4ee3\u7801\u91cd\u6784","\u6d4b\u8bd5\u8986\u76d6\u7387","\u4e8b\u52a1\u7ba1\u7406"]},"unlisted":false,"prevItem":{"title":"\u4f7f\u7528\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0","permalink":"/blog/gone-service-registry-discovery"}}')},8453:(n,e,r)=>{r.d(e,{R:()=>l,x:()=>t});var o=r(6540);const i={},s=o.createContext(i);function l(n){const e=o.useContext(s);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),o.createElement(s.Provider,{value:e},n.children)}},8742:(n,e,r)=>{r.d(e,{A:()=>o});const o=r.p+"assets/images/20250414-xorm-update-process_codecov-61448a9a5252c5d21d2710a47710c998.png"},8905:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>d,contentTitle:()=>t,default:()=>a,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var o=r(2251),i=r(4848),s=r(8453);const l={slug:"xorm-update-process",description:"\u672c\u6587\u8be6\u7ec6\u8bb0\u5f55\u4e86\u4f7f\u7528Gone\u6846\u67b6\u7684Provider\u673a\u5236\u91cd\u6784goner/xorm\u7ec4\u4ef6\u7684\u8fc7\u7a0b\u3002\u901a\u8fc7\u7edf\u4e00\u4f7f\u7528Provider\u673a\u5236\u5b9e\u73b0\uff0c\u4f18\u5316\u4e86\u4ee3\u7801\u7ed3\u6784\uff0c\u63d0\u9ad8\u4e86\u53ef\u7ef4\u62a4\u6027\u548c\u6d4b\u8bd5\u8986\u76d6\u7387\uff0c\u540c\u65f6\u4fdd\u6301\u4e86\u539f\u6709\u529f\u80fd\u548c\u914d\u7f6e\u7684\u517c\u5bb9\u6027\u3002\u6587\u7ae0\u6db5\u76d6\u4e86\u91cd\u6784\u7684\u52a8\u673a\u3001\u76ee\u6807\u3001\u8bbe\u8ba1\u65b9\u6848\u3001\u5b9e\u73b0\u7ec6\u8282\u548c\u6d4b\u8bd5\u7b56\u7565\u3002",keywords:["\u4f9d\u8d56\u6ce8\u5165","\u6570\u636e\u5e93\u8bbf\u95ee","\u4ee3\u7801\u91cd\u6784","Provider\u6a21\u5f0f","xorm","Gone\u6846\u67b6","\u6d4b\u8bd5\u8986\u76d6\u7387","\u4e8b\u52a1\u7ba1\u7406","SQL\u62fc\u63a5","\u4ee3\u7801\u4f18\u5316"],tags:["xorm","gone","\u6570\u636e\u5e93\u8bbf\u95ee","\u4ee3\u7801\u91cd\u6784","\u6d4b\u8bd5\u8986\u76d6\u7387","\u4e8b\u52a1\u7ba1\u7406"]},t="\u4f7f\u7528Provider\u673a\u5236\u6539\u9020goner/xorm",d={authorsImageUrls:[]},c=[{value:"\u7f18\u8d77",id:"\u7f18\u8d77",level:2},{value:"1.\u539f\u6765\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742",id:"1\u539f\u6765\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742",level:3},{value:"2.\u6d4b\u8bd5\u4e0d\u591f\u53cb\u597d\uff0c\u6bd4\u8f83\u96be\u505a\u8986\u76d6\u3002",id:"2\u6d4b\u8bd5\u4e0d\u591f\u53cb\u597d\u6bd4\u8f83\u96be\u505a\u8986\u76d6",level:3},{value:"\u76ee\u6807",id:"\u76ee\u6807",level:2},{value:"1. \u4fdd\u8bc1\u914d\u7f6e\u517c\u5bb9\u6539\u9020\u524d\u7684\uff0c\u4fdd\u8bc1\u6ce8\u5165\u65b9\u5f0f\u517c\u5bb9\u6539\u9020\u524d\u7684",id:"1-\u4fdd\u8bc1\u914d\u7f6e\u517c\u5bb9\u6539\u9020\u524d\u7684\u4fdd\u8bc1\u6ce8\u5165\u65b9\u5f0f\u517c\u5bb9\u6539\u9020\u524d\u7684",level:3},{value:"2. \u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u80fd\u6539\u53d8",id:"2-\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u80fd\u6539\u53d8",level:3},{value:"2.1 \u589e\u5f3a\u4e8b\u52a1\u652f\u6301",id:"21-\u589e\u5f3a\u4e8b\u52a1\u652f\u6301",level:4},{value:"2.2 \u589e\u5f3aSQL\u62fc\u63a5\u80fd\u529b",id:"22-\u589e\u5f3asql\u62fc\u63a5\u80fd\u529b",level:4},{value:"3. \u91c7\u7528v2\u7248\u672c\u7684Provider\u673a\u5236\u6765\u7edf\u4e00\u5b9e\u73b0",id:"3-\u91c7\u7528v2\u7248\u672c\u7684provider\u673a\u5236\u6765\u7edf\u4e00\u5b9e\u73b0",level:3},{value:"4. \u4f18\u5316\u4ee3\u7801\u8bbe\u8ba1\uff0c\u4f7f\u804c\u8d23\u66f4\u6e05\u6670\uff0c\u8fb9\u754c\u66f4\u5206\u660e",id:"4-\u4f18\u5316\u4ee3\u7801\u8bbe\u8ba1\u4f7f\u804c\u8d23\u66f4\u6e05\u6670\u8fb9\u754c\u66f4\u5206\u660e",level:3},{value:"\u8bbe\u8ba1",id:"\u8bbe\u8ba1",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0",level:2},{value:"1. \u5b9e\u73b0xormProvider\u53ca\u76f8\u5173Provider",id:"1-\u5b9e\u73b0xormprovider\u53ca\u76f8\u5173provider",level:3},{value:"2. \u5b9e\u73b0\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd",id:"2-\u5b9e\u73b0\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd",level:3},{value:"3. \u5b9e\u73b0Engine\u5c01\u88c5",id:"3-\u5b9e\u73b0engine\u5c01\u88c5",level:3},{value:"4. \u5b9e\u73b0Engine\u63d0\u4f9b\u8005",id:"4-\u5b9e\u73b0engine\u63d0\u4f9b\u8005",level:3},{value:"\u6d4b\u8bd5",id:"\u6d4b\u8bd5",level:2},{value:"\u6d4b\u8bd5\u8986\u76d6\u7387",id:"\u6d4b\u8bd5\u8986\u76d6\u7387",level:3},{value:"\u4e0b\u9762\u662f\u90e8\u5206\u6d4b\u8bd5\u4ee3\u7801\uff0c\u5c55\u793a\u4e86\u5982\u4f55\u6d4b\u8bd5xormProvider\uff1a",id:"\u4e0b\u9762\u662f\u90e8\u5206\u6d4b\u8bd5\u4ee3\u7801\u5c55\u793a\u4e86\u5982\u4f55\u6d4b\u8bd5xormprovider",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function g(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h2,{id:"\u7f18\u8d77",children:"\u7f18\u8d77"}),"\n",(0,i.jsxs)(e.p,{children:["\u6700\u8fd1\u5728\u7ed9 ",(0,i.jsx)(e.a,{href:"https://github.com/gone-io/goner",children:"goner"}),"\u589e\u52a0\u6d4b\u8bd5\u4ee3\u7801\uff0c\u63d0\u9ad8\u9879\u76ee\u7684\u6d4b\u8bd5\u8986\u76d6\u7387\u3002\u6539\u5230",(0,i.jsx)(e.code,{children:"goner/xorm"}),"\u65f6\uff0c\u53d1\u73b0\u5b58\u5728\u4e24\u4e2a\u4e3b\u8981\u95ee\u9898\uff1a"]}),"\n",(0,i.jsx)(e.h3,{id:"1\u539f\u6765\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742",children:"1.\u539f\u6765\u7684\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742"}),"\n",(0,i.jsx)(e.p,{children:"goner/xorm\u662fgone\u6846\u67b6\u4e2d\u8f83\u65e9\u63d0\u4f9b\u7684\u7ec4\u4ef6\uff0c\u5176\u6f14\u8fdb\u5386\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"v1.0\u7248\u672c\uff1a\u5b8c\u5168\u57fa\u4e8eGoner\u673a\u5236\u5b9e\u73b0"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"v1.2\u7248\u672c\uff1a\u5f15\u5165Provider\u673a\u5236\uff0c\u4e3a\u652f\u6301\u591a\u6570\u636e\u5e93\u548c\u96c6\u7fa4\u573a\u666f\u505a\u4e86\u589e\u91cf\u6539\u9020"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u76ee\u524d\u7684\u60c5\u51b5\u662fGoner\u673a\u5236\u548cProvider\u673a\u5236\u7684\u5b9e\u73b0\u540c\u65f6\u5b58\u5728\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u9ed8\u8ba4\u914d\u7f6e\u7684\u6570\u636e\u5e93\uff1a\u57fa\u4e8eGoner\u673a\u5236\u6ce8\u5165"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u96c6\u7fa4\u6570\u636e\u5e93\u6216\u591a\u6570\u636e\u5e93\uff1a\u4f7f\u7528Provider\u673a\u5236\u6ce8\u5165"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u79cd\u53cc\u673a\u5236\u5e76\u5b58\u7684\u8bbe\u8ba1\u589e\u52a0\u4e86\u4ee3\u7801\u7684\u590d\u6742\u6027\u548c\u7ef4\u62a4\u96be\u5ea6\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"2\u6d4b\u8bd5\u4e0d\u591f\u53cb\u597d\u6bd4\u8f83\u96be\u505a\u8986\u76d6",children:"2.\u6d4b\u8bd5\u4e0d\u591f\u53cb\u597d\uff0c\u6bd4\u8f83\u96be\u505a\u8986\u76d6\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4ee3\u7801\u7684\u8bbe\u8ba1\u804c\u8d23\u4e0d\u591f\u6e05\u6670\uff0c\u7ec4\u4ef6\u8fb9\u754c\u4e0d\u591f\u5206\u660e\uff0c\u5bfc\u81f4\u6d4b\u8bd5\u7f16\u5199\u56f0\u96be\uff0c\u96be\u4ee5\u5b9e\u73b0\u826f\u597d\u7684\u6d4b\u8bd5\u8986\u76d6\u7387\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u76ee\u6807",children:"\u76ee\u6807"}),"\n",(0,i.jsx)(e.h3,{id:"1-\u4fdd\u8bc1\u914d\u7f6e\u517c\u5bb9\u6539\u9020\u524d\u7684\u4fdd\u8bc1\u6ce8\u5165\u65b9\u5f0f\u517c\u5bb9\u6539\u9020\u524d\u7684",children:"1. \u4fdd\u8bc1\u914d\u7f6e\u517c\u5bb9\u6539\u9020\u524d\u7684\uff0c\u4fdd\u8bc1\u6ce8\u5165\u65b9\u5f0f\u517c\u5bb9\u6539\u9020\u524d\u7684"}),"\n",(0,i.jsx)(e.p,{children:"\u5148\u56de\u987egoner/xorm\u7684\u914d\u7f6e\u7ea6\u5b9a\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-yaml",children:"# database \u9ed8\u8ba4\u6570\u636e\u5e93\u914d\u7f6e\u524d\u7f00\ndatabase:\n    driver-name: mysql  # \u6570\u636e\u5e93\u9a71\u52a8\u540d\u79f0\n    dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options  # \u6570\u636e\u5e93\u8fde\u63a5\u5b57\u7b26\u4e32\n    max-idle-count: 10  # \u8fde\u63a5\u6c60\u6700\u5927\u7a7a\u95f2\u8fde\u63a5\u6570\n    max-open: 100  # \u8fde\u63a5\u6c60\u6700\u5927\u6253\u5f00\u8fde\u63a5\u6570\n    max-lifetime: 10s  # \u8fde\u63a5\u6700\u5927\u751f\u5b58\u65f6\u95f4\n    show-sql: true  # \u662f\u5426\u663e\u793aSQL\u8bed\u53e5\n    cluster:  # \u96c6\u7fa4\u914d\u7f6e\n        enable: false  # \u662f\u5426\u542f\u7528\u96c6\u7fa4\u6a21\u5f0f\n        master:  # \u4e3b\u5e93\u914d\u7f6e\n            driver-name: mysql\n            dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n        slaves:  # \u4ece\u5e93\u914d\u7f6e\u5217\u8868\n            - driver-name: mysql\n              dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n            - driver-name: mysql\n              dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n\n# \u81ea\u5b9a\u4e49\u6570\u636e\u5e93\u914d\u7f6e\u524d\u7f00\uff0ccustom-name \u662f\u81ea\u5b9a\u4e49\u7684\u6570\u636e\u5e93\u914d\u7f6e\u524d\u7f00\ncustom-name:\n    driver-name: mysql\n    dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n    max-idle-count: 10\n    max-open: 100\n    max-lifetime: 10s\n    show-sql: true\n    cluster:\n        enable: false\n        master:\n            driver-name: mysql\n            dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n        slaves:\n            - driver-name: mysql\n              dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n            - driver-name: mysql\n              dsn: user:password@tcp(IP_ADDRESS:3306)/dbname?options\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u518d\u56de\u987egoner/xorm\u7684\u6ce8\u5165\u65b9\u5f0f\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'//  \u9ed8\u8ba4\u914d\u7f6e\u524d\u7f00\u7684\u6570\u636e\u5e93\u6ce8\u5165\ntype defaultDbUser struct {\n    engine0 xorm.Engine `gone:"*"`  // \u6ce8\u5165\u9ed8\u8ba4\u914d\u7f6e\u524d\u7f00\u7684\u6570\u636e\u5e93\n    engine1 xorm.Engine `gone:"xorm,master"`  // \u6ce8\u5165\u9ed8\u8ba4\u914d\u7f6e\u6570\u636e\u5e93\u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 master \u6570\u636e\u5e93\n    engine2 []xorm.Engine `gone:"xorm"`  // \u6ce8\u5165\u9ed8\u8ba4\u914d\u7f6e\u6570\u636e\u5e93\u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\n    engine3 xorm.Engine `gone:"xorm,slave=0"`  // \u6ce8\u5165\u9ed8\u8ba4\u914d\u7f6e\u6570\u636e\u5e93\u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\u4e2d\u7684\u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\n    engine4 xorm.Engine `gone:"xorm,slave=1"`  // \u6ce8\u5165\u9ed8\u8ba4\u914d\u7f6e\u6570\u636e\u5e93\u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\u4e2d\u7684\u7b2c\u4e8c\u4e2a\u6570\u636e\u5e93\n}\n\n//  \u81ea\u5b9a\u4e49\u914d\u7f6e\u524d\u7f00\u7684\u6570\u636e\u5e93\u6ce8\u5165\ntype customerDbUser struct {\n    engine0 xorm.Engine `gone:"xorm,db=custom-name"`  // \u6ce8\u5165 \u914d\u7f6e\u524d\u7f00\u7b49\u4e8e custom-name \u7684\u6570\u636e\u5e93\n    engine1 xorm.Engine `gone:"xorm,db=custom-name,master"`  // \u6ce8\u5165 \u914d\u7f6e\u524d\u7f00\u7b49\u4e8e custom-name \u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 master \u6570\u636e\u5e93\n    engine2 []xorm.Engine `gone:"xorm,db=custom-name"`  // \u6ce8\u5165 \u914d\u7f6e\u524d\u7f00\u7b49\u4e8e custom-name \u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\n    engine3 xorm.Engine `gone:"xorm,db=custom-name,slave=0"`  // \u6ce8\u5165 \u914d\u7f6e\u524d\u7f00\u7b49\u4e8e custom-name \u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\u4e2d\u7684\u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\n    engine4 xorm.Engine `gone:"xorm,db=custom-name,slave=1"`  // \u6ce8\u5165 \u914d\u7f6e\u524d\u7f00\u7b49\u4e8e custom-name \u96c6\u7fa4\uff08\u5982\u679c\u5f00\u542f\u96c6\u7fa4\u6a21\u5f0f\uff09\u7684 slave \u6570\u636e\u5e93\u96c6\u5408\u4e2d\u7684\u7b2c\u4e8c\u4e2a\u6570\u636e\u5e93\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u6539\u9020\u540e\u5fc5\u987b\u4fdd\u6301\u4e0e\u4e0a\u8ff0\u914d\u7f6e\u683c\u5f0f\u548c\u6ce8\u5165\u65b9\u5f0f\u7684\u517c\u5bb9\u6027\uff0c\u4ee5\u786e\u4fdd\u7528\u6237\u4ee3\u7801\u65e0\u9700\u66f4\u6539\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"2-\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u80fd\u6539\u53d8",children:"2. \u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u80fd\u6539\u53d8"}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u529f\u80fd\u4e0a\uff0cgoner/xorm\u4e2d\u7684Engine\u5bf9xorm.io/xorm\u505a\u4e86\u4e24\u4e2a\u4e3b\u8981\u7684\u589e\u5f3a\uff1a"}),"\n",(0,i.jsx)(e.h4,{id:"21-\u589e\u5f3a\u4e8b\u52a1\u652f\u6301",children:"2.1 \u589e\u5f3a\u4e8b\u52a1\u652f\u6301"}),"\n",(0,i.jsx)(e.p,{children:"\u4f7f\u7528github.com/jtolds/gls\u589e\u5f3a\u4e8b\u52a1\uff0c\u66f4\u597d\u5730\u652f\u6301\u4e8b\u52a1\u5d4c\u5957\uff0c\u65e0\u9700\u624b\u52a8\u4f20\u9012\u4e8b\u52a1\u4e0a\u4e0b\u6587\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:"var db *xorm.Engine\n\n// \u4e3b\u6d41\u7a0b\u5904\u7406\u51fd\u6570\uff0c\u5f00\u542f\u9876\u5c42\u4e8b\u52a1\nfunc ProcessA(){\n    db.Transaction(func(session xorm.XInterface) error {\n        // \u8c03\u7528\u5176\u4ed6\u4e8b\u52a1\u51fd\u6570\uff0c\u65e0\u9700\u4f20\u9012session\n        ProcessB()\n        ProcessC()\n        return nil\n    })\n}\n\n// \u5b50\u6d41\u7a0bB\uff0c\u81ea\u52a8\u4f7f\u7528\u7236\u4e8b\u52a1\u4e0a\u4e0b\u6587\nfunc ProcessB(){\n    db.Transaction(func(session xorm.XInterface) error {\n        ProcessD()\n        return nil\n    })\n}\n\n// \u5b50\u6d41\u7a0bC\uff0c\u81ea\u52a8\u4f7f\u7528\u7236\u4e8b\u52a1\u4e0a\u4e0b\u6587\nfunc ProcessC(){\n    db.Transaction(func(session xorm.XInterface) error {\n        // \u5904\u7406\u5177\u4f53\u4e1a\u52a1\u903b\u8f91\n        return nil\n    })\n}\n\n// \u5b50\u6d41\u7a0bD\uff0c\u81ea\u52a8\u4f7f\u7528\u6700\u4e0a\u5c42\u4e8b\u52a1\u4e0a\u4e0b\u6587\nfunc ProcessD(){\n    db.Transaction(func(session xorm.XInterface) error {\n        // \u5904\u7406\u5177\u4f53\u4e1a\u52a1\u903b\u8f91\n        return nil\n    })\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u79cd\u8bbe\u8ba1\u53ef\u4ee5\u8ba9\u5f00\u53d1\u8005\u65e0\u9700\u5173\u5fc3\u4e8b\u52a1\u7684\u4f20\u9012\uff0c\u7b80\u5316\u5d4c\u5957\u4e8b\u52a1\u7684\u5904\u7406\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"22-\u589e\u5f3asql\u62fc\u63a5\u80fd\u529b",children:"2.2 \u589e\u5f3aSQL\u62fc\u63a5\u80fd\u529b"}),"\n",(0,i.jsx)(e.p,{children:"\u4f7f\u7528github.com/jmoiron/sqlx\u589e\u5f3aSQL\u62fc\u63a5\u80fd\u529b\uff0c\u63d0\u4f9bSqlx\u51fd\u6570\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'type dbUser struct {\n    gone.Flag\n    db xorm.Engine `gone:"*"`\n}\n\nfunc (s* dbUser)Query(){\n    // \u57fa\u672c\u53c2\u6570\u5316SQL\uff0c\u4f7f\u7528\u95ee\u53f7\u5360\u4f4d\u7b26\n    db.Sqlx("select * from user where id=?", 1).Exec()\n\n    // \u652f\u6301\u6570\u7ec4\u53c2\u6570\uff0c\u4f1a\u81ea\u52a8\u5c55\u5f00\u4e3a IN \u67e5\u8be2\n    db.Sqlx("select * from user where id in (?)", []int{1,2,3}).Exec()\n    // \u751f\u6210\u7684SQL: select * from user where id in (1,2,3)\n\n    // \u652f\u6301\u547d\u540d\u53c2\u6570\uff0c\u66f4\u76f4\u89c2\u6e05\u6670\n    db.Sqlx("select * from user where id in (:id) and status = :status", map[string]any{\n        "id": []int{1,2,3},\n        "status": 1,\n    }).Exec()\n    // \u751f\u6210\u7684SQL: select * from user where id in (1,2,3) and status = 1\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u79cd\u65b9\u5f0f\u8ba9SQL\u62fc\u63a5\u66f4\u52a0\u7075\u6d3b\u548c\u5b89\u5168\uff0c\u7279\u522b\u662f\u5904\u7406\u590d\u6742\u67e5\u8be2\u548c\u52a8\u6001\u6761\u4ef6\u65f6\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"3-\u91c7\u7528v2\u7248\u672c\u7684provider\u673a\u5236\u6765\u7edf\u4e00\u5b9e\u73b0",children:"3. \u91c7\u7528v2\u7248\u672c\u7684Provider\u673a\u5236\u6765\u7edf\u4e00\u5b9e\u73b0"}),"\n",(0,i.jsx)(e.p,{children:"\u6539\u9020\u7684\u6838\u5fc3\u76ee\u6807\u662f\u7edf\u4e00\u4f7f\u7528\u4e00\u79cd\u673a\u5236\uff08Provider\u673a\u5236\uff09\u6765\u5b9e\u73b0\u5168\u90e8\u529f\u80fd\uff0c\u907f\u514d\u53cc\u673a\u5236\u5e76\u5b58\u5e26\u6765\u7684\u590d\u6742\u6027\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"4-\u4f18\u5316\u4ee3\u7801\u8bbe\u8ba1\u4f7f\u804c\u8d23\u66f4\u6e05\u6670\u8fb9\u754c\u66f4\u5206\u660e",children:"4. \u4f18\u5316\u4ee3\u7801\u8bbe\u8ba1\uff0c\u4f7f\u804c\u8d23\u66f4\u6e05\u6670\uff0c\u8fb9\u754c\u66f4\u5206\u660e"}),"\n",(0,i.jsx)(e.p,{children:"\u4f18\u5316\u4ee3\u7801\u7ed3\u6784\u548c\u7ec4\u4ef6\u5212\u5206\uff0c\u4f7f\u6bcf\u4e2a\u7ec4\u4ef6\u804c\u8d23\u5355\u4e00\u660e\u786e\uff0c\u7ec4\u4ef6\u4e4b\u95f4\u8fb9\u754c\u6e05\u6670\uff0c\u4fbf\u4e8e\u6d4b\u8bd5\u548c\u7ef4\u62a4\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u8bbe\u8ba1",children:"\u8bbe\u8ba1"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\u7f16\u5199",(0,i.jsx)(e.strong,{children:"xormProvider"}),"\u8bfb\u53d6\u7ea6\u5b9a\u914d\u7f6e\uff0c\u4e3a\u7cfb\u7edf\u63d0\u4f9b",(0,i.jsx)(e.code,{children:"xorm.io/xorm"}),"\u7684",(0,i.jsx)(e.code,{children:"xorm.EngineInterface"}),"\u7c7b\u578b\u5b9e\u4f8b\uff1b"]}),"\n",(0,i.jsxs)(e.li,{children:["\u4f7f\u7528",(0,i.jsx)(e.code,{children:"gone.WrapFunctionProvider"}),"\u5305\u88c5",(0,i.jsx)(e.code,{children:"xormProvider"}),"\uff0c\u4e3a\u7cfb\u7edf\u63d0\u4f9b",(0,i.jsx)(e.code,{children:"*xorm.Engine"}),"\u548c",(0,i.jsx)(e.code,{children:"*xorm.EngineGroup"}),"\u7c7b\u578b\u5b9e\u4f8b\uff1b"]}),"\n",(0,i.jsxs)(e.li,{children:["\u4f7f\u7528",(0,i.jsx)(e.code,{children:"eng"})," \u5c01\u88c5",(0,i.jsx)(e.code,{children:"xorm.EngineInterface"}),"\uff0c\u5b9e\u73b0\u539f\u6765",(0,i.jsx)(e.code,{children:"goner/xorm"}),"\u4e2d\u5b9a\u4e49\u7684\u7684",(0,i.jsx)(e.code,{children:"Engine"}),"\u63a5\u53e3\uff0c\u5b8c\u6210\u4e8b\u52a1\u589e\u5f3a\u548cSQL\u62fc\u63a5\u589e\u5f3a\uff1b"]}),"\n",(0,i.jsxs)(e.li,{children:["\u4f7f\u7528",(0,i.jsx)(e.code,{children:"engProvider"}),"\u4e3a\u7cfb\u7edf\u63d0\u4f9b",(0,i.jsx)(e.code,{children:"goner/xorm.Engine"}),"\u7c7b\u578b\u5b9e\u4f8b\u3002"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{src:r(1821).A+"",width:"1471",height:"1132"})}),"\n",(0,i.jsx)(e.h2,{id:"\u5b9e\u73b0",children:"\u5b9e\u73b0"}),"\n",(0,i.jsxs)(e.p,{children:["\u4e0b\u9762\u662f\u6539\u9020\u7684\u6838\u5fc3\u5b9e\u73b0\u4ee3\u7801\uff0c\u5b8c\u6574\u4ee3\u7801\u53ef\u5728GitHub\u4ed3\u5e93\u67e5\u770b\uff1a",(0,i.jsx)(e.a,{href:"https://github.com/gone-io/goner/tree/main/xorm",children:"\u5b8c\u6574\u4ee3\u7801"}),"\u3002"]}),"\n",(0,i.jsx)(e.h3,{id:"1-\u5b9e\u73b0xormprovider\u53ca\u76f8\u5173provider",children:"1. \u5b9e\u73b0xormProvider\u53ca\u76f8\u5173Provider"}),"\n",(0,i.jsx)(e.p,{children:"\u9996\u5148\u5b9e\u73b0xormProvider\u53ca\u5176\u5c01\u88c5\u7c7bxormEngineProvider\u548cxormGroupProvider\uff0c\u7528\u4e8e\u63d0\u4f9b\u539f\u751f\u7684xorm\u5bf9\u8c61\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// xorm_provide.go\npackage xorm\n\nimport (\n    "fmt"\n    "github.com/gone-io/gone/v2"\n    "xorm.io/xorm"\n)\n\ntype xormProvider struct {\n    gone.Flag\n    configure gone.Configure   `gone:"configure"`\n    logger    gone.Logger      `gone:"*"`\n    policy    xorm.GroupPolicy `gone:"*" option:"allowNil"`\n\n    dbMap map[string]xorm.EngineInterface\n}\n\nfunc (s *xormProvider) Init() {\n    s.dbMap = make(map[string]xorm.EngineInterface)\n}\n\n// ... \u7701\u7565\u90e8\u5206\u4ee3\u7801\n\n// Provide \u6839\u636e\u6807\u7b7e\u914d\u7f6e\u63d0\u4f9bxorm.EngineInterface\u5b9e\u4f8b\nfunc (s *xormProvider) Provide(tag string) (eng xorm.EngineInterface, err error) {\n    dbName := getDbName(tag)\n\n    if eng = s.dbMap[dbName]; eng == nil {\n        eng, err = s.configAndInitDb(dbName)\n        if err != nil {\n            return nil, gone.ToError(err)\n        }\n        s.dbMap[dbName] = eng\n    }\n    return eng, nil\n}\n\n// configAndInitDb \u6839\u636e\u6570\u636e\u5e93\u540d\u79f0\u914d\u7f6e\u5e76\u521d\u59cb\u5316\u6570\u636e\u5e93\u8fde\u63a5\nfunc (s *xormProvider) configAndInitDb(dbName string) (eng xorm.EngineInterface, err error) {\n    var config Conf\n    var enableCluster bool\n\n    _ = s.configure.Get(dbName, &config, "")\n    _ = s.configure.Get(dbName+".cluster.enable", &enableCluster, "false")\n\n    if !enableCluster {\n        // \u521b\u5efa\u5355\u4e00\u6570\u636e\u5e93\u8fde\u63a5\n        eng, err = xorm.NewEngine(config.DriverName, config.Dsn)\n        if err != nil {\n            return nil, gone.ToErrorWithMsg(err, "failed to create engine for db: "+dbName)\n        }\n    } else {\n        // \u521b\u5efa\u6570\u636e\u5e93\u96c6\u7fa4\u8fde\u63a5\n        // ... \u4ee3\u7801\u7701\u7565\n    }\n\n    // \u914d\u7f6e\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u548c\u5176\u4ed6\u9009\u9879\n    if config.MaxIdleCount > 0 {\n        eng.SetMaxIdleConns(config.MaxIdleCount)\n    }\n    if config.MaxOpen > 0 {\n        eng.SetMaxOpenConns(config.MaxOpen)\n    }\n    if config.MaxLifetime > 0 {\n        eng.SetConnMaxLifetime(config.MaxLifetime)\n    }\n    eng.ShowSQL(config.ShowSql)\n    eng.SetLogger(&dbLogger{Logger: s.logger, showSql: config.ShowSql})\n    // \u6839\u636e\u914d\u7f6e\u68c0\u6d4b\u8fde\u63a5\u662f\u5426\u53ef\u7528\n    if config.PingAfterInit {\n        if err = eng.Ping(); err != nil {\n            return nil, gone.ToErrorWithMsg(err, "failed to ping db: "+dbName)\n        }\n    }\n    return eng, nil\n}\n\n// \u63d0\u4f9b\u539f\u751fEngine\u5b9e\u4f8b\nfunc (s *xormProvider) ProvideEngine(tagConf string) (*xorm.Engine, error) {\n    // ... \u4ee3\u7801\u7701\u7565\n}\n\n// \u63d0\u4f9b\u539f\u751fEngineGroup\u5b9e\u4f8b\nfunc (s *xormProvider) ProvideEngineGroup(tagConf string) (*xorm.EngineGroup, error) {\n    // ... \u4ee3\u7801\u7701\u7565\n}\n\n// \u5c01\u88c5\u51fd\u6570Provider\uff0c\u63d0\u4f9b*xorm.Engine\nvar xormEngineProvider = gone.WrapFunctionProvider(func(tagConf string, param struct {\n    xormProvider *xormProvider `gone:"*"`\n}) (*xorm.Engine, error) {\n    return param.xormProvider.ProvideEngine(tagConf)\n})\n\n// \u5c01\u88c5\u51fd\u6570Provider\uff0c\u63d0\u4f9b*xorm.EngineGroup\nvar xormGroupProvider = gone.WrapFunctionProvider(func(tagConf string, param struct {\n    xormProvider *xormProvider `gone:"*"`\n}) (*xorm.EngineGroup, error) {\n    return param.xormProvider.ProvideEngineGroup(tagConf)\n})\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u90e8\u5206\u4ee3\u7801\u7684\u4e3b\u8981\u529f\u80fd\u662f\u89e3\u6790\u914d\u7f6e\u6587\u4ef6\uff0c\u6839\u636e\u914d\u7f6e\u521b\u5efa\u6570\u636e\u5e93\u8fde\u63a5\uff0c\u5e76\u63d0\u4f9b\u539f\u751f\u7684xorm\u5f15\u64ce\u5bf9\u8c61\u3002\u5173\u952e\u70b9\u5305\u62ec\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u652f\u6301\u5355\u4e00\u6570\u636e\u5e93\u8fde\u63a5\u548c\u4e3b\u4ece\u96c6\u7fa4\u8fde\u63a5"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u5b9e\u73b0\u914d\u7f6e\u89e3\u6790\u548c\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u914d\u7f6e"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u63d0\u4f9b\u539f\u751f\u7684xorm.Engine\u548cxorm.EngineGroup\u5b9e\u4f8b"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"2-\u5b9e\u73b0\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd",children:"2. \u5b9e\u73b0\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd"}),"\n",(0,i.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u5b9e\u73b0\u4e8b\u52a1\u589e\u5f3a\u90e8\u5206\uff0c\u63d0\u4f9b\u5d4c\u5957\u4e8b\u52a1\u652f\u6301\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// trans.go\npackage xorm\n\nimport (\n    "fmt"\n    "github.com/gone-io/gone/v2"\n    "github.com/jtolds/gls"\n    "sync"\n)\n\nfunc newTrans(logger gone.Logger, newSession func() Session) trans {\n    return trans{\n        logger:     logger,\n        newSession: newSession,\n    }\n}\n\ntype trans struct {\n    logger     gone.Logger\n    newSession func() Session\n}\n\nvar sessionMap = sync.Map{}\n\n// \u83b7\u53d6\u4e8b\u52a1\u4f1a\u8bdd\uff0c\u5982\u679c\u5f53\u524dgoroutine\u6ca1\u6709\u4e8b\u52a1\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u4f1a\u8bdd\nfunc (e *trans) getTransaction(id uint) (Session, bool) {\n    session, suc := sessionMap.Load(id)\n    if suc {\n        return session.(Session), false\n    } else {\n        s := e.newSession()\n        sessionMap.Store(id, s)\n        return s, true\n    }\n}\n\n// \u5220\u9664\u4e8b\u52a1\u5e76\u5173\u95ed\u4f1a\u8bdd\nfunc (e *trans) delTransaction(id uint, session Session) error {\n    defer sessionMap.Delete(id)\n    return session.Close()\n}\n\n// Transaction \u5728\u4e8b\u52a1\u4e2d\u6267\u884cSQL\nfunc (e *trans) Transaction(fn func(session Interface) error) error {\n    var err error\n    gls.EnsureGoroutineId(func(gid uint) {\n        session, isNew := e.getTransaction(gid)\n\n        if isNew {\n            // \u5f53\u524dgoroutine\u6ca1\u6709\u6d3b\u8dc3\u4e8b\u52a1\uff0c\u521b\u5efa\u65b0\u4e8b\u52a1\n            rollback := func() {\n                rollbackErr := session.Rollback()\n                if rollbackErr != nil {\n                    e.logger.Errorf("rollback err:%v", rollbackErr)\n                    err = gone.ToErrorWithMsg(err, fmt.Sprintf("rollback error: %v", rollbackErr))\n                }\n            }\n\n            isRollback := false\n            defer func(e *trans, id uint, session Session) {\n                err := e.delTransaction(id, session)\n                if err != nil {\n                    e.logger.Errorf("del session err:%v", err)\n                }\n            }(e, gid, session)\n\n            // \u5904\u7406panic\u60c5\u51b5\uff0c\u786e\u4fdd\u4e8b\u52a1\u56de\u6eda\n            defer func() {\n                if info := recover(); info != nil {\n                    e.logger.Errorf("session rollback for panic: %s", info)\n                    e.logger.Errorf("%s", gone.PanicTrace(2, 1))\n                    if !isRollback {\n                        rollback()\n                        err = gone.NewInnerError(fmt.Sprintf("%s", info), gone.DbRollForPanicError)\n                    } else {\n                        err = gone.ToErrorWithMsg(info, fmt.Sprintf("rollback for err: %v, but panic for", err))\n                    }\n                }\n            }()\n\n            // \u5f00\u59cb\u4e8b\u52a1\n            err = session.Begin()\n            if err != nil {\n                err = gone.ToError(err)\n                return\n            }\n\n            // \u6267\u884c\u7528\u6237\u51fd\u6570\n            err = gone.ToError(fn(session))\n            if err == nil {\n                // \u4e8b\u52a1\u63d0\u4ea4\n                err = gone.ToError(session.Commit())\n            } else {\n                // \u4e8b\u52a1\u56de\u6eda\n                e.logger.Errorf("session rollback for err: %v", err)\n                isRollback = true\n                rollback()\n            }\n        } else {\n            // \u5f53\u524dgoroutine\u5df2\u6709\u6d3b\u8dc3\u4e8b\u52a1\uff0c\u590d\u7528\u73b0\u6709\u4e8b\u52a1\n            err = gone.ToError(fn(session))\n        }\n    })\n    return err\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u4e8b\u52a1\u589e\u5f3a\u7684\u6838\u5fc3\u662f\u901a\u8fc7goroutine\u672c\u5730\u5b58\u50a8(gls)\u5b9e\u73b0\uff0c\u8fd9\u6837\u53ef\u4ee5\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u5728\u540c\u4e00goroutine\u4e2d\u81ea\u52a8\u5171\u4eab\u4e8b\u52a1\u4e0a\u4e0b\u6587"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u652f\u6301\u5d4c\u5957\u4e8b\u52a1\u8c03\u7528\uff0c\u5185\u5c42\u4e8b\u52a1\u51fd\u6570\u81ea\u52a8\u4f7f\u7528\u5916\u5c42\u4e8b\u52a1"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u63d0\u4f9b\u7edf\u4e00\u7684\u9519\u8bef\u5904\u7406\u548c\u56de\u6eda\u673a\u5236"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"3-\u5b9e\u73b0engine\u5c01\u88c5",children:"3. \u5b9e\u73b0Engine\u5c01\u88c5"}),"\n",(0,i.jsx)(e.p,{children:"\u7136\u540e\u5b9e\u73b0eng\u7ed3\u6784\u4f53\uff0c\u5c01\u88c5\u539f\u751f\u7684xorm\u63a5\u53e3\u5e76\u589e\u5f3a\u529f\u80fd\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'//eng.go\npackage xorm\n\nimport (\n    "github.com/gone-io/gone/v2"\n    "xorm.io/xorm"\n)\n\nfunc newEng(xEng xorm.EngineInterface, logger gone.Logger) *eng {\n    e := eng{EngineInterface: xEng}\n    e.trans = newTrans(logger, func() Session {\n        return e.NewSession()\n    })\n    return &e\n}\n\ntype eng struct {\n    xorm.EngineInterface  // \u5d4c\u5165\u539f\u751fxorm\u63a5\u53e3\n    trans                 // \u5d4c\u5165\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd\n}\n\n// \u83b7\u53d6\u539f\u59cb\u5f15\u64ce\u5b9e\u4f8b\nfunc (e *eng) GetOriginEngine() xorm.EngineInterface {\n    return e.EngineInterface\n}\n\n// \u8bbe\u7f6e\u4e3b\u4ece\u7b56\u7565\nfunc (e *eng) SetPolicy(policy xorm.GroupPolicy) {\n    if group, ok := e.EngineInterface.(*xorm.EngineGroup); ok {\n        group.SetPolicy(policy)\n    }\n}\n\n// \u589e\u5f3a\u7684SQL\u62fc\u63a5\u529f\u80fd\nfunc (e *eng) Sqlx(sql string, args ...any) *xorm.Session {\n    sql, args = sqlDeal(sql, args...)\n    return e.SQL(sql, args...)\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u4e2a\u5c01\u88c5\u5c42\u5b9e\u73b0\u4e86\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u5d4c\u5165\u539f\u751fxorm\u63a5\u53e3\u4fdd\u6301API\u517c\u5bb9"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u96c6\u6210\u4e8b\u52a1\u589e\u5f3a\u529f\u80fd"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u6dfb\u52a0SQL\u62fc\u63a5\u589e\u5f3a\u529f\u80fd"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"4-\u5b9e\u73b0engine\u63d0\u4f9b\u8005",children:"4. \u5b9e\u73b0Engine\u63d0\u4f9b\u8005"}),"\n",(0,i.jsx)(e.p,{children:"\u6700\u540e\uff0c\u5b9e\u73b0engProvider\u4e3a\u5e94\u7528\u63d0\u4f9b\u589e\u5f3a\u7248\u7684Engine\u5b9e\u4f8b\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'//eng_provider.go\npackage xorm\n\nimport (\n    "github.com/gone-io/gone/v2"\n    "github.com/spf13/cast"\n    "reflect"\n)\n\ntype engProvider struct {\n    gone.Flag\n    logger    gone.Logger   `gone:"*"`\n    xProvider *xormProvider `gone:"*"`\n}\n\nfunc (s *engProvider) GonerName() string {\n    return "xorm" // \u6ce8\u518c\u4e3axorm\u540d\u79f0\n}\n\n// \u63d0\u4f9b\u5b9e\u4f8b\uff0c\u6839\u636e\u7c7b\u578b\u548c\u914d\u7f6e\u63d0\u4f9b\u4e0d\u540c\u7684\u5b9e\u4f8b\nfunc (s *engProvider) Provide(tagConf string, t reflect.Type) (any, error) {\n    switch t {\n    case xormInterfaceSlice: // \u63d0\u4f9bEngine\u5207\u7247\n        group, err := s.xProvider.ProvideEngineGroup(tagConf)\n        if err != nil {\n            return nil, gone.ToError(err)\n        }\n        slaves := group.Slaves()\n        engines := make([]Engine, 0, len(slaves))\n        for _, slave := range slaves {\n            engines = append(engines, newEng(slave, s.logger))\n        }\n        return engines, nil\n    case xormInterface: // \u63d0\u4f9b\u5355\u4e00Engine\n        return s.ProvideEngine(tagConf)\n    default:\n        return nil, gone.NewInnerErrorWithParams(gone.GonerTypeNotMatch, "Cannot find matched value for %q", gone.GetTypeName(t))\n    }\n}\n\n// \u6839\u636e\u6807\u7b7e\u914d\u7f6e\u63d0\u4f9bEngine\u5b9e\u4f8b\nfunc (s *engProvider) ProvideEngine(tagConf string) (Engine, error) {\n    m, _ := gone.TagStringParse(tagConf)\n\n    // \u5904\u7406master\u6807\u8bb0\n    if v, ok := m[masterKey]; ok && (v == "" || cast.ToBool(v)) {\n        group, err := s.xProvider.ProvideEngineGroup(tagConf)\n        if err != nil {\n            return nil, gone.ToError(err)\n        }\n        return newEng(group.Master(), s.logger), nil\n    }\n\n    // \u5904\u7406slave\u6807\u8bb0\n    if index, ok := m[slaveKey]; ok {\n        i := cast.ToInt(index)\n        group, err := s.xProvider.ProvideEngineGroup(tagConf)\n        if err != nil {\n            return nil, gone.ToError(err)\n        }\n        slaves := group.Slaves()\n        if i < 0 || i >= len(slaves) {\n            return nil, gone.ToError("slave index out of range")\n        }\n        return newEng(slaves[i], s.logger), nil\n    }\n\n    // \u63d0\u4f9b\u9ed8\u8ba4\u5f15\u64ce\n    provideEngine, err := s.xProvider.Provide(tagConf)\n    if err != nil {\n        return nil, gone.ToError(err)\n    }\n    return newEng(provideEngine, s.logger), nil\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u4e2aProvider\u5b9e\u73b0\u4e86\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:'\u5c06\u81ea\u8eab\u6ce8\u518c\u4e3a"xorm"\u540d\u79f0\uff0c\u4e0e\u539f\u6765\u7684\u6ce8\u5165\u6807\u7b7e\u4fdd\u6301\u4e00\u81f4\uff1b'}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u80fd\u591f\u63d0\u4f9b\u5355\u4e2aEngine\u5b9e\u4f8b\u6216Engine\u5207\u7247\uff1b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u6839\u636e\u6807\u7b7e\u914d\u7f6e\u63d0\u4f9b\u4e3b\u5e93\u3001\u4ece\u5e93\u6216\u9ed8\u8ba4\u6570\u636e\u5e93\u5b9e\u4f8b\uff1b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u4f7f\u7528newEng\u5305\u88c5\u539f\u751f\u5f15\u64ce\u5b9e\u4f8b\uff0c\u589e\u5f3a\u5176\u529f\u80fd\u3002"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u6d4b\u8bd5",children:"\u6d4b\u8bd5"}),"\n",(0,i.jsx)(e.h3,{id:"\u6d4b\u8bd5\u8986\u76d6\u7387",children:"\u6d4b\u8bd5\u8986\u76d6\u7387"}),"\n",(0,i.jsx)(e.p,{children:"\u6d4b\u8bd5\u662f\u9a8c\u8bc1\u6539\u9020\u6210\u529f\u7684\u5173\u952e\u73af\u8282\u3002\u901a\u8fc7\u7f16\u5199\u5168\u9762\u7684\u6d4b\u8bd5\u7528\u4f8b\uff0c\u6211\u4eec\u4e0d\u4ec5\u80fd\u9a8c\u8bc1\u529f\u80fd\u6b63\u786e\u6027\uff0c\u8fd8\u80fd\u63d0\u9ad8\u4ee3\u7801\u7684\u6d4b\u8bd5\u8986\u76d6\u7387\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u6d4b\u8bd5\u8986\u76d6\u7387"}),"\n",(0,i.jsxs)(e.p,{children:["\u5982\u56fe\u6240\u793a\uff0c\u6539\u9020\u540e\u7684\u4ee3\u7801\u6d4b\u8bd5\u8986\u76d6\u7387\u5f97\u5230\u4e86\u663e\u8457\u63d0\u5347\u3002\n",(0,i.jsx)(e.img,{src:r(8742).A+"",width:"1077",height:"877"})]}),"\n",(0,i.jsx)(e.h3,{id:"\u4e0b\u9762\u662f\u90e8\u5206\u6d4b\u8bd5\u4ee3\u7801\u5c55\u793a\u4e86\u5982\u4f55\u6d4b\u8bd5xormprovider",children:"\u4e0b\u9762\u662f\u90e8\u5206\u6d4b\u8bd5\u4ee3\u7801\uff0c\u5c55\u793a\u4e86\u5982\u4f55\u6d4b\u8bd5xormProvider\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-go",children:'// xorm_provider_test.go\npackage xorm\n\nimport (\n    "database/sql"\n    "github.com/DATA-DOG/go-sqlmock"\n    "github.com/gone-io/gone/v2"\n    "github.com/stretchr/testify/assert"\n    "os"\n    "testing"\n    "xorm.io/xorm"\n)\n\nfunc Test_xormProvider_Init(t *testing.T) {\n    // \u521b\u5efaSQL\u6a21\u62df\u5668\uff0c\u7528\u4e8e\u6a21\u62df\u6570\u636e\u5e93\u64cd\u4f5c\u800c\u65e0\u9700\u771f\u5b9e\u6570\u636e\u5e93\n    db, mock, _ := sqlmock.NewWithDSN(\n        "root@/blog",\n        sqlmock.MonitorPingsOption(true),\n    )\n    defer db.Close()\n\n    // \u6ce8\u518c\u6a21\u62df\u7684\u6570\u636e\u5e93\u9a71\u52a8\n    drivers := sql.Drivers()\n    if !contains(drivers, "mysql") {\n        sql.Register("mysql", db.Driver())\n    }\n\n    // \u5b9a\u4e49\u6d4b\u8bd5\u7528\u4f8b\u7ed3\u6784\n    type Tests struct {\n        name        string\n        before      func()         // \u6d4b\u8bd5\u524d\u51c6\u5907\n        after       func()         // \u6d4b\u8bd5\u540e\u6e05\u7406\n        exceptPanic bool           // \u662f\u5426\u671f\u671b\u53d1\u751fpanic\n        injectFn    any            // \u4f9d\u8d56\u6ce8\u5165\u6d4b\u8bd5\u51fd\u6570\n    }\n\n    tests := []Tests{\n        {\n            name: "inject default db failed",\n            before: func() {\n                // \u8bbe\u7f6e\u9519\u8bef\u7684\u9a71\u52a8\u540d\u79f0\uff0c\u9884\u671f\u4f1a\u5931\u8d25\n                _ = os.Setenv("GONE_DATABASE", `{\n                    "driver-name":"error",\n                    "dsn": "root@/blog",\n                    "max-idle-count": 5,\n                    "max-open": 10,\n                    "max-lifetime": 10000,\n                    "show-sql": true,\n                    "ping-after-init": true\n                }`)\n            },\n            after: func() {\n                _ = os.Unsetenv("GONE_DATABASE")\n            },\n            injectFn: func(in struct {\n                db *xorm.Engine `gone:"*"`\n            }) {\n                assert.NotNil(t, db)\n            },\n            exceptPanic: true, // \u9884\u671f\u4f1a\u53d1\u751fpanic\n        },\n        \n        // ... \u66f4\u591a\u6d4b\u8bd5\u7528\u4f8b\n        \n        {\n            name: "inject default db",\n            before: func() {\n                // \u8bbe\u7f6e\u6b63\u786e\u7684\u6570\u636e\u5e93\u914d\u7f6e\n                _ = os.Setenv("GONE_DATABASE", `{\n                    "driver-name":"mysql",\n                    "dsn": "root@/blog",\n                    "max-idle-count": 5,\n                    "max-open": 10,\n                    "max-lifetime": 10000,\n                    "show-sql": true,\n                    "ping-after-init": true\n                }`)\n                mock.ExpectPing() // \u671f\u671b\u6267\u884cping\u64cd\u4f5c\n            },\n            after: func() {\n                _ = os.Unsetenv("GONE_DATABASE")\n            },\n            injectFn: func(in struct {\n                db1      *xorm.Engine         `gone:""`\n                db2      *xorm.Engine         `gone:"*"`\n                db       xorm.EngineInterface `gone:"*"`\n                injector gone.StructInjector  `gone:"*"`\n            }) {\n                // \u9a8c\u8bc1\u6ce8\u5165\u7684\u5b9e\u4f8b\u662f\u5426\u7b26\u5408\u9884\u671f\n                assert.NotNil(t, in.db1)\n                assert.NotNil(t, in.db2)\n                assert.Equal(t, in.db1, in.db2)\n                assert.Equal(t, in.db1, in.db)\n\n                // \u5c1d\u8bd5\u6ce8\u5165\u4e0d\u517c\u5bb9\u7684\u7c7b\u578b\uff0c\u9884\u671f\u4f1a\u5931\u8d25\n                var x struct {\n                    db *xorm.EngineGroup `gone:"*"`\n                }\n                err := in.injector.InjectStruct(&x)\n                assert.Error(t, err)\n            },\n            exceptPanic: false, // \u4e0d\u671f\u671b\u53d1\u751fpanic\n        },\n        \n        // ... \u66f4\u591a\u6d4b\u8bd5\u7528\u4f8b\n    }\n\n    // \u6267\u884c\u6240\u6709\u6d4b\u8bd5\u7528\u4f8b\n    for _, tt := range tests {\n        t.Run(tt.name, func(t *testing.T) {\n            tt.before()\n            defer tt.after()\n\n            func() {\n                defer func() {\n                    err := recover()\n                    if tt.exceptPanic {\n                        assert.Error(t, err.(error))\n                    } else {\n                        assert.Nil(t, err)\n                    }\n                }()\n\n                // \u542f\u52a8\u5e94\u7528\u5e76\u6267\u884c\u6d4b\u8bd5\u51fd\u6570\n                gone.\n                    NewApp().\n                    Load(&xormProvider{}).\n                    Load(xormEngineProvider).\n                    Load(xormGroupProvider).\n                    Run(tt.injectFn)\n            }()\n        })\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u6bb5\u6d4b\u8bd5\u4ee3\u7801\u4f7f\u7528\u4e86\u591a\u79cd\u6d4b\u8bd5\u6280\u5de7\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"SQL\u6a21\u62df\uff1a\u4f7f\u7528sqlmock\u5e93\u6a21\u62df\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u65e0\u9700\u771f\u5b9e\u6570\u636e\u5e93\u5373\u53ef\u8fdb\u884c\u6d4b\u8bd5"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff1a\u901a\u8fc7\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u6a21\u62df\u4e0d\u540c\u7684\u914d\u7f6e\u573a\u666f"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u4f9d\u8d56\u6ce8\u5165\u6d4b\u8bd5\uff1a\u5229\u7528gone\u6846\u67b6\u7684\u4f9d\u8d56\u6ce8\u5165\u7cfb\u7edf\u9a8c\u8bc1\u5404\u79cd\u6ce8\u5165\u573a\u666f"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u5f02\u5e38\u6d4b\u8bd5\uff1a\u901a\u8fc7recover\u6355\u83b7\u5e76\u9a8c\u8bc1\u9884\u671f\u7684panic\u60c5\u51b5"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u7ec4\u4ef6\u4ea4\u4e92\u6d4b\u8bd5\uff1a\u6d4b\u8bd5\u4e0d\u540c\u7ec4\u4ef6\u4e4b\u95f4\u7684\u4ea4\u4e92\u884c\u4e3a"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u8fd9\u4e9b\u6d4b\u8bd5\u7528\u4f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u5168\u9762\u9a8c\u8bc1\u6539\u9020\u540e\u7684\u529f\u80fd\u662f\u5426\u6b63\u5e38\u5de5\u4f5c\uff0c\u540c\u65f6\u63d0\u9ad8\u4ee3\u7801\u7684\u6d4b\u8bd5\u8986\u76d6\u7387\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u8fd9\u6b21\u6539\u9020\uff0c\u6211\u4eec\u6210\u529f\u5730\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u7edf\u4e00\u4e86xorm\u7ec4\u4ef6\u7684\u5b9e\u73b0\u673a\u5236\uff0c\u5168\u90e8\u91c7\u7528Provider\u673a\u5236\uff0c\u7b80\u5316\u4e86\u4ee3\u7801\u7ed3\u6784"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u4fdd\u6301\u4e86\u4e0e\u539f\u6709\u914d\u7f6e\u548c\u6ce8\u5165\u65b9\u5f0f\u7684\u517c\u5bb9\u6027\uff0c\u786e\u4fdd\u7528\u6237\u4ee3\u7801\u65e0\u9700\u66f4\u6539"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u4fdd\u7559\u5e76\u589e\u5f3a\u4e86\u539f\u6709\u529f\u80fd\uff0c\u5305\u62ec\u4e8b\u52a1\u7ba1\u7406\u548cSQL\u62fc\u63a5\u80fd\u529b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u91cd\u6784\u4e86\u4ee3\u7801\u7ed3\u6784\uff0c\u4f7f\u5404\u7ec4\u4ef6\u804c\u8d23\u66f4\u52a0\u6e05\u6670\uff0c\u8fb9\u754c\u66f4\u52a0\u5206\u660e"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"\u63d0\u9ad8\u4e86\u4ee3\u7801\u7684\u53ef\u6d4b\u8bd5\u6027\uff0c\u663e\u8457\u63d0\u5347\u4e86\u6d4b\u8bd5\u8986\u76d6\u7387"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u6b21\u6539\u9020\u4e0d\u4ec5\u63d0\u9ad8\u4e86\u4ee3\u7801\u8d28\u91cf\uff0c\u8fd8\u4e3a\u672a\u6765\u7684\u529f\u80fd\u6269\u5c55\u548c\u7ef4\u62a4\u5960\u5b9a\u4e86\u826f\u597d\u57fa\u7840\u3002\u901a\u8fc7\u5408\u7406\u91c7\u7528\u8bbe\u8ba1\u6a21\u5f0f\u548c\u5206\u5c42\u67b6\u6784\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4fdd\u6301\u517c\u5bb9\u6027\u7684\u540c\u65f6\uff0c\u4e0d\u65ad\u4f18\u5316\u548c\u6f14\u8fdb\u7cfb\u7edf\u3002"})]})}function a(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(g,{...n})}):g(n)}}}]);